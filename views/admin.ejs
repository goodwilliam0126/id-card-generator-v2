<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta htp-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <title>위조민증 등록</title>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* 모바일 반응형 스타일 */
        body {
            background-color: #0a0a0a;
            font-size: 14px;
        }

        /* 네비게이션 바 */
        .navbar {
            padding: 12px 15px;
        }

        .navbar a {
            color: #fff !important;
            font-size: 16px;
            font-weight: 500;
        }

        /* 컨테이너 여백 조정 */
        .content-section {
            margin: 15px 15px;
        }

        /* 카드 스타일 */
        .card {
            border: 0px;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .card-header {
            background-color: #121212;
            color: rgb(253, 251, 241);
            padding: 12px 15px;
            font-weight: 600;
            font-size: 16px;
        }

        .card-body {
            background-color: #1d1d1d;
            color: rgb(253, 251, 241);
            padding: 15px;
        }

        /* 테이블 반응형 */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table {
            background-color: #121212;
            color: rgb(255, 255, 255);
            margin-bottom: 0;
            font-size: 13px;
        }

        .table th,
        .table td {
            padding: 10px 8px;
            vertical-align: middle;
            border-color: #2a2a2a;
        }

        /* 모바일에서 테이블 헤더 고정 */
        @media (max-width: 768px) {
            body {
                font-size: 13px;
            }

            .content-section {
                margin: 10px 10px;
            }

            .card-header {
                font-size: 15px;
                padding: 10px 12px;
            }

            .table {
                font-size: 12px;
                display: block;
                width: 100%;
            }

            .table thead {
                display: none;
            }

            .table tbody {
                display: block;
                width: 100%;
            }

            .table tr {
                display: block;
                margin-bottom: 15px;
                background-color: #1a1a1a;
                border-radius: 8px;
                padding: 10px;
                border: 1px solid #2a2a2a;
            }

            .table td {
                display: block;
                text-align: left;
                padding: 8px 10px;
                border: none;
                position: relative;
                padding-left: 40%;
            }

            .table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                font-weight: 600;
                color: #aaa;
            }

            .table td:first-child {
                text-align: center;
                padding-left: 10px;
            }

            .table td:first-child::before {
                display: none;
            }

            /* 버튼 크기 조정 */
            .btn {
                padding: 8px 16px;
                font-size: 13px;
                margin: 2px;
            }

            /* 이미지 중앙 정렬 */
            .profile-img-container {
                display: flex;
                justify-content: center;
                margin-bottom: 10px;
            }
        }

        /* 버튼 스타일 */
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        /* 공지사항 스타일 */
        .notice-content {
            text-align: center;
            font-size: 16px;
            padding: 15px;
            background-color: #121212;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .notice-content {
                font-size: 14px;
                padding: 12px;
            }
        }

        /* 텍스트 영역 */
        textarea {
            background-color: #121212;
            color: #fff;
            border: 1px solid #2a2a2a;
            border-radius: 5px;
            padding: 10px;
        }

        /* 프로필 이미지 */
        .profile-img-container {
            width: 60px;
            height: 90px;
            border-radius: 10%;
            overflow: hidden;
            display: inline-block;
        }

        .profile-img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 링크 스타일 */
        a {
            color: #fff;
            text-decoration: none;
        }

        a:hover {
            color: #0d6efd;
        }
    </style>
</head>
<script type="text/javascript" language="javascript">
    // 모바일 웹 주소창 숨기기
    window.addEventListener('load', function() {
        setTimeout(scrollTo, 0, 0, 1);
    }, false);
</script>
<body>
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light border-bottom" style="background-color: #0e0f0f;border: 0px; color: #fff;">
            <a style="margin-left: 10px; cursor: pointer;">
                위조민증
            </a>
            <a onclick="return goto()" style="margin-left: 8px; cursor: pointer;">
                [제작]
            </a>
        </nav>

        <!-- 공지사항 -->
        <div class="content-section">
            <div class="card">
                <div class="card-header">
                    공지사항
                </div> 
                <div class="card-body">
                    <div class="notice-content"><%= User_data.data[0].Notice %></div>
                </div>
            </div>
        </div>

        <!-- 관리 섹션 -->
        <div class="content-section">
            <div class="card">
                <div class="card-header">
                    관리
                    <button style="float: right;" class="btn btn-primary btn-sm" onclick="return goto()">추가</button>
                </div> 
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>증명사진</th>
                                    <th>이름</th>
                                    <th>주민등록번호</th>
                                    <th>주소</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if(User_data.Token_data.length == 0) { %> 
                                    <tr>
                                        <td data-label="증명사진">데이터 없음</td>
                                        <td data-label="이름">데이터 없음</td>
                                        <td data-label="주민등록번호">데이터 없음</td>
                                        <td data-label="주소">데이터 없음</td>
                                        <td data-label="관리">데이터 없음</td>
                                    </tr>
                                <% } %>
                                <% for(const i in User_data.Token_data) { %>
                                    <tr>
                                        <td data-label="증명사진">
                                            <div class="profile-img-container">
                                                <img src="<%= User_data.Token_data[i].img_link %>" alt="증명사진">
                                            </div>
                                        </td>
                                        <td data-label="이름">
                                            <a href="/?token=<%= User_data.Token_data[i].token %>"><%= User_data.Token_data[i].name %></a>
                                        </td>
                                        <td data-label="주민등록번호"><%= User_data.Token_data[i].registration %></td>
                                        <td data-label="주소"><%= User_data.Token_data[i].address %><br><%= User_data.Token_data[i].address2 %></td>
                                        <td data-label="관리">
                                            <button class="btn btn-primary" onclick="return doAction('<%= User_data.Token_data[i].token %>')">관리</button>
                                            <button class="btn btn-primary" onclick="window.location.href='/?token=<%= User_data.Token_data[i].token %>'">접속</button>
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 관리자 전용 섹션 -->
        <% if(admin === true) { %> 
            <!-- 유저 관리 -->
            <div class="content-section">
                <div class="card">
                    <div class="card-header">
                        유저
                        <button style="float: right;" class="btn btn-primary btn-sm" onclick="return create()">추가</button>
                    </div> 
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>아이디</th>
                                        <th>권한</th>
                                        <th>토큰</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if(data.length == 0) { %> 
                                        <tr>
                                            <td data-label="아이디">데이터 없음</td>
                                            <td data-label="권한">데이터 없음</td>
                                            <td data-label="토큰">데이터 없음</td>
                                            <td data-label="관리">데이터 없음</td>
                                        </tr>
                                    <% } %>
                                    <% for(const i in data) { %>
                                        <tr>
                                            <td data-label="아이디">
                                                <a href="/admin?token=<%= data[i].token %>"><%= data[i].id %></a>
                                            </td>
                                            <td data-label="권한"><%= data[i].role %></td>
                                            <td data-label="토큰" style="word-break: break-all;"><%= data[i].token %></td>
                                            <td data-label="관리">
                                                <button class="btn btn-danger btn-sm" onclick="return deletes('<%= data[i].token %>')">삭제</button>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 공지사항 수정 -->
            <div class="content-section">
                <div class="card">
                    <div class="card-header">
                        수정
                        <button style="float: right;" class="btn btn-primary btn-sm" onclick="return save()">저장</button>
                    </div> 
                    <div class="card-body">
                        <textarea id="notice_admin" style="width:100%;" rows="5"><%= User_data.data[0].Notice %></textarea>
                    </div>
                </div>
            </div>
        <% } %>

    </div>

    <script>
        function goto() {
            const url = new URL(window.location.href);
            const urlParams = url.searchParams;
            let token = urlParams.get('token')
            window.location.href = `/create?token=${token}`
        }

        function doAction(data) {
            const url = new URL(window.location.href);
            const urlParams = url.searchParams;
            let token = urlParams.get('token')
            window.location.href = `/edit?token=${token}&user_token=${data}`
        }

        function create() {
            Swal.fire({
                title: 'ID를 입력해주세요',
                input: 'text',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: '다음',
                showLoaderOnConfirm: true,
                preConfirm: (data) => {
                    let id = data
                    Swal.fire({
                        title: '토큰을 입력해주세요',
                        input: 'text',
                        inputAttributes: {
                            autocapitalize: 'off'
                        },
                        showCancelButton: true,
                        confirmButtonText: '다음',
                        showLoaderOnConfirm: true,
                        preConfirm: (data) => {
                            let token = data
                            Swal.fire({
                                title: '권한을 입력해주세요. (ex. Admin/User)',
                                input: 'text',
                                inputAttributes: {
                                    autocapitalize: 'off'
                                },
                                showCancelButton: true,
                                confirmButtonText: '다음',
                                showLoaderOnConfirm: true,
                                preConfirm: (data) => {
                                    let role = data
                                    const url = new URL(window.location.href);
                                    const urlParams = url.searchParams;
                                    let admin_token = urlParams.get('token')
                                    return fetch('/api/admin_create', {
                                        method: 'post',
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            token,
                                            id,
                                            role,
                                            admin_token
                                        })
                                    }).then((data) => {
                                        if(data.ok != true) return alert("알 수 없는 이유로 유저를 제작하는 데 실패했습니다")
                                        alert("성공적으로 유저를 제작하였습니다.")
                                        return window.location.href = `/admin?token=${admin_token}`
                                    })
                                },
                                allowOutsideClick: () => !Swal.isLoading()
                            })
                        },
                        allowOutsideClick: () => !Swal.isLoading()
                    })
                },
                allowOutsideClick: () => !Swal.isLoading()
            })
        }

        function save() {
            const url = new URL(window.location.href);
            const urlParams = url.searchParams;
            let admin_token = urlParams.get('token')
            let textarea = document.querySelector("#notice_admin").value
            fetch('/api/admin_noticeSave', {
                method: 'post',
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    admin_token,
                    textarea
                })
            }).then(data => {
                if(data.ok != true) return alert("알 수 없는 오류로 데이터 저장에 실패했어요.")
                alert("데이터 저장에 성공했습니다")
                return window.location.href = `/admin?token=${admin_token}`
            })
        }

        function deletes(token) {
            const url = new URL(window.location.href);
            const urlParams = url.searchParams;
            let admin_token = urlParams.get('token')
            if(admin_token === token) return alert("본인의 토큰은 지울 수 없습니다.")

            fetch('/api/delete', {
                method: 'post',
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    type: 'Admin',
                    token,
                    admin_token
                })
            }).then((data) => {
                if(data.ok != true) return alert("알 수 없는 이유로 데이터를 지우지 못했어요.")
                alert("데이터를 삭제했습니다")
                return window.location.href = `/admin?token=${admin_token}`
            }).catch(err => {
                alert(err)
                console.log(err)
            })
        }
    </script>

</body>
</html>
